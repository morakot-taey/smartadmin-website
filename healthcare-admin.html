<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการระบบ - Healthcare Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
      // Script to redirect if not logged in as admin
      window.addEventListener('DOMContentLoaded', function() {
        const user = sessionStorage.getItem('current_healthcare_user');
        if (!user || JSON.parse(user).role !== 'admin') {
          window.location.href = 'healthcare.html';
        }
      });
      function logoutToHome() {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    </script>
    <style>
        :root {
            --background-url: url('https://img2.pic.in.th/pic/Home-6.png');
            --primary-text-color: #FFFFFF;
            --secondary-text-color: #E0E0E0;
            --container-bg: rgba(255, 255, 255, 0.15); 
            --section-bg: rgba(0, 0, 0, 0.2);
            --table-bg: rgba(0, 0, 0, 0.15);
            --table-header-bg: rgba(0, 0, 0, 0.3);
            --modal-bg: rgba(245,245,245,0.98);
            --border-color: rgba(255,255,255,0.2);
            --button-bg: rgba(255,255,255,0.1);
            --button-hover-bg: rgba(255,255,255,0.2);
            --action-button-bg: #4CAF50;
            --delete-button-bg: #f44336;
            --text-shadow: 1px 1px 8px rgba(0,0,0,0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0)), var(--background-url) center/cover no-repeat fixed;
            padding: 20px;
            color: var(--primary-text-color);
        }
        .background-logo { position: fixed; top: 15px; left: 15px; width: 150px; z-index: 1000; opacity: 0.9; }
        .main-container {
            background: var(--container-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px; /* Adjusted padding */
            width: 100%; /* Changed from 95% */
            max-width: 1600px;
            margin: 80px auto 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
        }
        h1, h2, h3 { color: var(--primary-text-color); text-shadow: var(--text-shadow); }
        h1 i, h2 i { margin-right: 10px; }
        .nav-button {
            color: var(--primary-text-color);
            font-weight: 500;
            text-decoration: none;
            font-size: 1rem;
            background: var(--button-bg);
            padding: 8px 15px;
            border-radius: 10px;
            transition: background-color 0.3s;
            border: 1px solid var(--border-color);
            text-shadow: var(--text-shadow);
        }
        .nav-button:hover { background: var(--button-hover-bg); }
        .section-box {
            background: var(--section-bg);
            padding: 15px; /* Adjusted padding */
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px; /* Adjusted padding */
            flex-wrap: wrap;
            gap: 15px;
        }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-direction: column; }
        .filters input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%; /* Full width on mobile */
            background: rgba(0,0,0,0.2);
            color: #fff;
        }
        .table-container { max-height: 500px; overflow-x: auto; overflow-y: auto; border-radius: 8px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; background-color: var(--table-bg); }
        th, td { padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--secondary-text-color); text-align: left; white-space: nowrap; font-size: 0.9rem; }
        th { background-color: var(--table-header-bg); position: sticky; top: 0; z-index: 1; color: var(--primary-text-color); font-weight: 600; }
        td i.fa-mars { color: #64b5f6; } td i.fa-venus { color: #f06292; } .gender-icon { margin-right: 8px; }
        .action-button, .management-button { background: var(--button-bg); border: 1px solid var(--border-color); color: #fff; padding: 6px 12px; margin: 0 2px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; font-size: 0.8rem; }
        .action-button:hover, .management-button:hover { background: var(--button-hover-bg); }
        .action-button.edit { background-color: var(--action-button-bg); }
        .management-button.delete { background-color: var(--delete-button-bg); }
        
        /* Modal Styles */
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 9000; backdrop-filter: blur(5px); }
        .modal { display: none; position: fixed; z-index: 10000; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 800px; background: var(--modal-bg); border-radius: 18px; box-shadow: 0 4px 32px #0007; color: #333; }
        .modal.open, .modal-backdrop.active { display: block; }
        .modal-header { padding: 15px 20px; font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid #ddd; }
        .modal-content { padding: 20px; max-height: 75vh; overflow-y: auto; }
        .modal-footer { padding: 15px; text-align: right; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-close-btn { position: absolute; top: 12px; right: 15px; font-size: 24px; background: none; border: none; color: #888; cursor: pointer; }
        .modal label { font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block; }
        .modal input, .modal select { width: 100%; padding: 10px; font-size: 0.9rem; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; }
        #edit-form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        #delete-employees-inputs { display: grid; grid-template-columns: 1fr; gap: 10px; }
        /* --- ✅ Responsive Adjustments --- */
        /* Tablet and larger screens */
        @media (min-width: 768px) {
            .main-container { padding: 25px; }
            .section-box { padding: 20px; }
            .filters { flex-direction: row; }
            .filters input { width: 220px; }
            #edit-form-grid { grid-template-columns: 1fr 1fr; gap: 15px 20px; }
            #delete-employees-inputs { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .modal { width: 90%; }
        }
        /* Small mobile screens */
        @media (max-width: 480px) {
            body { padding: 10px; }
            .main-container { margin-top: 70px; padding: 15px; }
            .background-logo { width: 120px; top: 10px; left: 10px; }
            h1 { font-size: 1.2rem; }
            h2 { font-size: 1.1rem; }
            .nav-button, .management-button { font-size: 0.8rem; padding: 6px 10px; }
            .section-header { flex-direction: column; align-items: flex-start; }
            th, td { font-size: 0.75rem; padding: 8px; }
        }
    </style>
</head>
<body>
    <img src="https://img5.pic.in.th/file/secure-sv1/-1c3d81610977de24c.png" alt="Logo" class="background-logo">
    <div class="main-container">
        <div class="main-header">
            <h1><i class="fas fa-user-shield"></i> หน้าสำหรับผู้ดูแลระบบ</h1>
            <div class="navigation"> <a href="#" class="nav-button" onclick="logoutToHome()"><i class="fas fa-home"></i> หน้าแรก</a> </div>
        </div>
        <div class="section-box">
            <div class="section-header">
                <h2><i class="fas fa-tasks"></i> ส่วนจัดการข้อมูล</h2>
                <button class="management-button delete" onclick="openDeleteModal()"><i class="fas fa-user-minus"></i> ลบพนักงานที่ลาออก</button>
            </div>
            <div class="filters">
                <input type="text" id="searchId" placeholder="ค้นหารหัสพนักงาน..." onkeyup="filterAndRender()">
                <input type="text" id="searchName" placeholder="ค้นหาชื่อ..." onkeyup="filterAndRender()">
                <input type="text" id="searchCompany" placeholder="ค้นหา บริษัท..." onkeyup="filterAndRender()">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>รหัสพนักงาน</th> <th>ชื่อ – สกุล</th> <th>เพศ</th> <th>วันเกิด</th> <th>วันที่เริ่มงาน</th> <th>แผนก</th> <th>สังกัด</th> <th>บริษัท</th> <th>ตำแหน่ง</th> <th>สัญชาติ</th> <th>Passport-Id</th> <th>WorkPermit Id</th> <th>เลขที่ประกันสังคม</th> <th>เลขกรมธรรม์ฯ</th> <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Edit Employee Modal -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-modal" class="modal">
        <button class="modal-close-btn" onclick="closeAllModals()">&times;</button>
        <div class="modal-header">แก้ไขข้อมูลพนักงาน</div>
        <div class="modal-content">
            <form id="edit-form">
                <div id="edit-form-grid">
                    <div><label>รหัสพนักงาน</label><input type="text" id="edit-EmployeeCardNo" readonly></div>
                    <div><label>คำนำหน้า</label><input type="text" id="edit-คำนำหน้า"></div>
                    <div><label>ชื่อ</label><input type="text" id="edit-ชื่อ"></div>
                    <div><label>สกุล</label><input type="text" id="edit-สกุล"></div>
                    <div><label>เพศ (M/F)</label><input type="text" id="edit-เพศ"></div>
                    <div><label>วันเกิด</label><input type="date" id="edit-BirthDate"></div>
                    <div><label>วันที่เริ่มงาน</label><input type="date" id="edit-StartJobDate"></div>
                    <div><label>แผนก</label><input type="text" id="edit-แผนก"></div>
                    <div><label>สังกัด</label><input type="text" id="edit-สังกัด"></div>
                    <div><label>บริษัท</label><input type="text" id="edit-CompanyCode"></div>
                    <div><label>ตำแหน่ง</label><input type="text" id="edit-PositionAlt"></div>
                    <div><label>สัญชาติ</label><input type="text" id="edit-NationName"></div>
                    <div><label>Passport-Id</label><input type="text" id="edit-passportId"></div>
                    <div><label>WorkPermit Id</label><input type="text" id="edit-workPermitId"></div>
                    <div><label>เลขที่ประกันสังคม</label><input type="text" id="edit-ssfId"></div>
                    <div><label>เลขกรมธรรม์ฯ</label><input type="text" id="edit-เลขกรมธรรม์ประกันอุบัติเหตุ"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="management-button" onclick="closeAllModals()">ยกเลิก</button>
            <button class="management-button action-button edit" onclick="saveEmployeeChanges()">บันทึกการเปลี่ยนแปลง</button>
        </div>
    </div>
    <!-- Delete Employees Modal -->
    <div id="delete-modal" class="modal">
        <button class="modal-close-btn" onclick="closeAllModals()">&times;</button>
        <div class="modal-header">ลบพนักงานที่ลาออก</div>
        <div class="modal-content">
            <h3>กรอกรหัสพนักงานที่ต้องการลบ (สูงสุด 10 คน)</h3>
            <div id="delete-employees-inputs">
                <!-- Inputs will be generated here by JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="management-button" onclick="closeAllModals()">ยกเลิก</button>
            <button class="management-button delete" onclick="deleteEmployees()">ยืนยันการลบ</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // --- ไม่มีการแก้ไขโค้ด JavaScript ใดๆ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFep1y9I0OR5Hu_Gf0Mbywu-PEgFdQD2k",
            authDomain: "smartadmin-hr-project.firebaseapp.com",
            databaseURL: "https://smartadmin-hr-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smartadmin-hr-project",
            storageBucket: "smartadmin-hr-project.firebasestorage.app",
            messagingSenderId: "797763301010",
            appId: "1:797763301010:web:2c4b5e24ac0750e67cc04b"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        
        const db = firebase.database();
        const masterDataRef = db.ref('master_data_import');
        let rawData = [];
        let currentlyEditingIndex = null;
        const safeGet = (value, defaultValue = '-') => (value === undefined || value === null || value === '') ? defaultValue : value;
        document.addEventListener('DOMContentLoaded', function() {
            masterDataRef.on('value', (snapshot) => {
                rawData = snapshot.val() || [];
                if (!Array.isArray(rawData)) {
                    console.error("Master data is not an array!", rawData);
                    rawData = [];
                }
                filterAndRender();
            });
        });
        function mapDataForDisplay(data) {
            return data.map(row => ({
                'Employee Code': safeGet(row['EmployeeCardNo']),
                'Name – Surname': `${safeGet(row['คำนำหน้า'])}  ${safeGet(row['ชื่อ'])}  ${safeGet(row['สกุล'])}`.trim(),
                'Gender': safeGet(row['เพศ']), 'Birth Date': safeGet(row['BirthDate']),
                'Start Job Date': safeGet(row['StartJobDate']), 'Department': safeGet(row['แผนก']),
                'Affiliation': safeGet(row['สังกัด']), 'Company': safeGet(row['CompanyCode']),
                'Position': safeGet(row['PositionAlt']), 'Nation Name': safeGet(row['NationName']),
                'Passport-Id': safeGet(row['passportId']), 'WorkPermit Id': safeGet(row['workPermitId']),
                'เลขที่ประกันสังคม': safeGet(row['ssfId']), 'เลขกรมธรรม์ประกันอุบัติเหตุ': safeGet(row['เลขกรมธรรม์ประกันอุบัติเหตุ'])
            }));
        }
        function filterAndRender() {
            const searchId = document.getElementById('searchId').value.trim().toLowerCase();
            const searchName = document.getElementById('searchName').value.trim().toLowerCase();
            const searchCompany = document.getElementById('searchCompany').value.trim().toLowerCase();
            
            let filteredRawData = rawData;
            if (searchId) filteredRawData = filteredRawData.filter(row => safeGet(row['EmployeeCardNo']).toLowerCase().includes(searchId));
            if (searchName) filteredRawData = filteredRawData.filter(row => `${safeGet(row['ชื่อ'])} ${safeGet(row['สกุล'])}`.toLowerCase().includes(searchName));
            if (searchCompany) filteredRawData = filteredRawData.filter(row => safeGet(row['CompanyCode']).toLowerCase().includes(searchCompany));
            
            renderTable(filteredRawData);
        }
        function renderTable(dataToRender) {
            const tableBody = document.getElementById('employeeTableBody');
            tableBody.innerHTML = '';
            if (dataToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="15" style="text-align:center;">ไม่พบข้อมูล</td></tr>';
                return;
            }
            const displayData = mapDataForDisplay(dataToRender);
            displayData.forEach((emp) => {
                const genderIcon = emp.Gender === 'M' ? '<i class="fas fa-mars gender-icon"></i>' : '<i class="fas fa-venus gender-icon"></i>';
                const row = `
                    <tr>
                        <td>${emp['Employee Code']}</td> <td>${genderIcon}${emp['Name – Surname']}</td>
                        <td>${emp['Gender']}</td> <td>${emp['Birth Date']}</td> <td>${emp['Start Job Date']}</td>
                        <td>${emp['Department']}</td> <td>${emp['Affiliation']}</td> <td>${emp['Company']}</td>
                        <td>${emp['Position']}</td> <td>${emp['Nation Name']}</td> <td>${emp['Passport-Id']}</td>
                        <td>${emp['WorkPermit Id']}</td> <td>${emp['เลขที่ประกันสังคม']}</td> <td>${emp['เลขกรมธรรม์ประกันอุบัติเหตุ']}</td>
                        <td><button class="action-button edit" onclick="openEditModal('${emp['Employee Code']}')"><i class="fas fa-edit"></i></button></td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        // --- Modal Functions ---
        function closeAllModals() {
            document.getElementById('modal-backdrop').classList.remove('active');
            document.getElementById('edit-modal').classList.remove('open');
            document.getElementById('delete-modal').classList.remove('open');
        }
        // --- Edit Employee ---
        function openEditModal(empId) {
            currentlyEditingIndex = rawData.findIndex(row => row.EmployeeCardNo === empId);
            if (currentlyEditingIndex === -1) {
                alert("ไม่พบข้อมูลพนักงาน");
                return;
            }
            const empData = rawData[currentlyEditingIndex];
            for (const key in empData) {
                const input = document.getElementById(`edit-${key.replace(/\(/g, '\(').replace(/\)/g, '\)')}`);
                if (input) {
                    input.value = empData[key] || '';
                }
            }
            document.getElementById('modal-backdrop').classList.add('active');
            document.getElementById('edit-modal').classList.add('open');
        }
        async function saveEmployeeChanges() {
            if (currentlyEditingIndex === null) return;
            const updatedData = {};
            const form = document.getElementById('edit-form');
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                const key = input.id.replace('edit-', '');
                updatedData[key] = input.value;
            });
            const path = `master_data_import/${currentlyEditingIndex}`;
            try {
                await db.ref(path).update(updatedData);
                alert('อัปเดตข้อมูลสำเร็จ!');
                closeAllModals();
            } catch (err) {
                alert('เกิดข้อผิดพลาดในการอัปเดต: ' + err.message);
            }
        }
        // --- Delete Employees ---
        function openDeleteModal() {
            const container = document.getElementById('delete-employees-inputs');
            container.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                container.insertAdjacentHTML('beforeend', `<input type="text" placeholder="รหัสพนักงานคนที่ ${i}">`);
            }
            document.getElementById('modal-backdrop').classList.add('active');
            document.getElementById('delete-modal').classList.add('open');
        }
        async function deleteEmployees() {
            const inputs = document.querySelectorAll('#delete-employees-inputs input');
            const idsToDelete = Array.from(inputs).map(input => input.value.trim()).filter(id => id);
            if (idsToDelete.length === 0) {
                alert("กรุณากรอกรหัสพนักงานที่ต้องการลบ");
                return;
            }
            if (!confirm(`คุณต้องการลบพนักงานจำนวน ${idsToDelete.length} คนใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้`)) {
                return;
            }
            try {
                const updatedData = rawData.filter(row => !idsToDelete.includes(row.EmployeeCardNo));
                await masterDataRef.set(updatedData);
                alert(`ลบข้อมูลพนักงาน ${idsToDelete.length} คนสำเร็จ`);
                closeAllModals();
            } catch (err) {
                alert('เกิดข้อผิดพลาดในการลบ: ' + err.message);
            }
        }
    </script>
</body>
</html>
