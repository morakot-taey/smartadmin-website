<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Sticker Management</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--bg-color: rgba(0, 0, 0, 0.4);
--blur-bg: rgba(255, 255, 255, 0.1);
--border-color: rgba(255, 255, 255, 0.2);
--text-color: #ffffff;
--input-bg: rgba(255, 255, 255, 0.15);
--input-border: rgba(255, 255, 255, 0.3);
--primary-color: #4CAF50;
--secondary-color: #007bff;
--danger-color: #d9534f;
--warning-color: #ffc107;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
min-height: 100vh;
background: linear-gradient(var(--bg-color), var(--bg-color)), url('https://img2.pic.in.th/pic/Home-6.png') center/cover no-repeat fixed;
display: flex;
justify-content: center;
align-items: flex-start;
padding: 20px;
color: var(--text-color);
}
.background-logo {
position: fixed; top: 20px; left: 20px; width: 150px; z-index: 1000; opacity: 0.9;
}
.container {
background: var(--blur-bg);
backdrop-filter: blur(20px);
border: 1px solid var(--border-color);
border-radius: 20px;
padding: 25px 30px;
width: 100%;
max-width: 1800px;
box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
margin-top: 80px; 
}
.header {
display: flex;
justify-content: space-between;
align-items: center;
border-bottom: 1px solid var(--border-color);
padding-bottom: 15px;
margin-bottom: 20px;
}
.header h1 { font-size: 1.8rem; }
.admin-info { display: flex; align-items: center; gap: 15px; }
#logout-btn {
background: rgba(217, 83, 79, 0.5); border: 1px solid rgba(217, 83, 79, 0.8);
color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;
}
#logout-btn:hover { background: rgba(217, 83, 79, 0.8); }
.tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.tab {
padding: 10px 20px; cursor: pointer; background: var(--input-bg);
border: 1px solid var(--input-border); border-radius: 8px;
transition: all 0.2s;
}
.tab.active, .tab:hover { background: rgba(255, 255, 255, 0.3); }
.content { display: none; }
.content.active { display: block; }
.table-wrapper { overflow-x: auto; margin-top: 10px; }
table { width: 100%; border-collapse: collapse; table-layout: auto; }
th, td { border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left; white-space: nowrap; vertical-align: middle; }
th { font-weight: 600; }
tr { transition: background-color 0.2s; }
tbody tr:hover { background-color: rgba(255, 255, 255, 0.2); }
.action-btn-group { display: flex; gap: 8px; align-items: center;}
.action-btn {
border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer;
color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
}
.btn-approve { background: var(--primary-color); }
.btn-reject { background: var(--danger-color); }
.btn-delete { background: #6c757d; }
.btn-edit { background: var(--secondary-color); }
.btn-save { background: #28a745; }
.status-pending { color: var(--warning-color); font-weight: bold; }
.status-approved { color: var(--primary-color); font-weight: bold; }
.status-rejected { color: var(--danger-color); font-weight: bold; }
.file-indicator { font-size: 1.3rem; }
.file-indicator.fa-check-circle { color: #4CAF50; }
.file-indicator.fa-times-circle { color: rgba(255, 255, 255, 0.4); }
.details-column { white-space: normal; min-width: 250px; }
.details-column span { display: block; margin-bottom: 4px; }
.details-column strong { color: var(--text-color); opacity: 0.8; }
.details-column .plate-number { font-weight: 700; color: #8ab4f8; font-size: 1.1em; }
.editable-cell input, .editable-cell select {
    width: 95%;
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--secondary-color);
    color: white;
    padding: 5px;
    border-radius: 4px;
    font-family: inherit;
    font-size: inherit;
}
.editable-cell select option { background-color: #333; }
#search-op-area, #search-checkpoint3 {
    padding: 10px 15px;
    width: 100%;
    max-width: 400px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    color: white;
    font-size: 1rem;
    margin-bottom: 15px;
}
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}
.dashboard-card {
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}
.dashboard-card h3 { font-size: 1.2rem; color: var(--text-color); opacity: 0.8; margin-bottom: 10px; }
.dashboard-card .count { font-size: 2.5rem; font-weight: 700; }
#export-summary-btn, #export-checkpoint3-btn {
    padding: 12px 25px; font-size: 1rem; border-radius: 8px; border: none; cursor: pointer;
    background-color: var(--secondary-color); color: white; margin-bottom: 15px;
}
.modal-overlay {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
display: none; justify-content: center; align-items: center; z-index: 2000;
}
.modal-content {
background: rgba(40, 40, 40, 0.8); border: 1px solid var(--border-color);
padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
}
.modal-content h2 { margin-bottom: 20px; }
.modal-content input { width: 100%; padding: 12px; margin-bottom: 20px; background: var(--input-bg); color: var(--text-color); border-radius: 8px; border: 1px solid var(--input-border); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-actions button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; }
.modal-actions .btn-confirm { background-color: var(--primary-color); color: white; }
.modal-actions .btn-cancel { background-color: #6c757d; color: white; }
</style>
</head>
<body>
<img src="https://img5.pic.in.th/file/secure-sv1/-1c3d81610977de24c.png" alt="Logo" class="background-logo">
<div class="container">
<div class="header">
<h1><i class="fas fa-tasks"></i> Sticker Management</h1>
<div class="admin-info">
<span><i class="fas fa-user-shield"></i> Admin ID: <strong id="admin-id-display"></strong></span>
<button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>
</div>
<div class="tabs">
    <div class="tab active" onclick="showTab('summary')">สรุปข้อมูล</div>
    <div class="tab" onclick="showTab('op_area')">คำขอ (เขตประกอบการ)</div>
    <div class="tab" onclick="showTab('checkpoint3')">คำขอ (ป้อม 3)</div>
</div>
<!-- Content for Summary Dashboard -->
<div id="summary_content" class="content active">
    <h2>Dashboard (รวมทุกประเภท)</h2>
    <div class="dashboard-grid">
        <div class="dashboard-card"><h3>คำขอทั้งหมด</h3><p id="total-requests" class="count">0</p></div>
        <div class="dashboard-card"><h3>อนุมัติแล้ว</h3><p id="approved-requests" class="count">0</p></div>
        <div class="dashboard-card"><h3>รออนุมัติ</h3><p id="pending-requests" class="count">0</p></div>
        <div class="dashboard-card"><h3>ไม่อนุมัติ</h3><p id="rejected-requests" class="count">0</p></div>
    </div>
    <button id="export-summary-btn"><i class="fas fa-file-excel"></i> Export ประวัติการอนุมัติทั้งหมด</button>
    
    <div class="table-wrapper">
        <h2>ประวัติการอนุมัติ</h2>
        <table id="logs_table">
            <thead>
                <tr><th>วันที่-เวลา</th><th>Admin</th><th>ประเภทคำขอ</th><th>ชื่อ-สกุล</th><th>ทะเบียนรถ</th><th>เลขสติ๊กเกอร์</th><th>สถานะ</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- Content for Operating Area -->
<div id="op_area_content" class="content">
<h2>คำขอ (เขตประกอบการ)</h2>
<input type="text" id="search-op-area" placeholder="ค้นหาข้อมูลในตาราง..." onkeyup="filterTable('op_area_table', this.value)">
<div class="table-wrapper">
<table id="op_area_table">
<thead>
    <tr>
        <th>เวลาที่ขอ</th>
        <th>ข้อมูลพนักงาน</th>
        <th>ข้อมูลรถ</th>
        <th>ไฟล์แนบ</th>
        <th>สถานะ</th>
        <th>จัดการ</th>
    </tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Content for Checkpoint 3 -->
<div id="checkpoint3_content" class="content">
    <h2>คำขอ (ป้อม 3)</h2>
    <input type="text" id="search-checkpoint3" placeholder="ค้นหาข้อมูลในตาราง..." onkeyup="filterTable('checkpoint3_table', this.value)">
    <button id="export-checkpoint3-btn"><i class="fas fa-file-excel"></i> Export ข้อมูลป้อม 3</button>
    <div class="table-wrapper">
    <table id="checkpoint3_table">
        <thead>
            <tr>
                <th>เวลาที่ขอ</th>
                <th>ข้อมูลพนักงาน</th>
                <th>ข้อมูลรถ</th>
                <th>ข้อมูลติดต่อ</th>
                <th>สถานะ</th>
                <th>จัดการ</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>
</div>
</div>
<!-- Approval Modal -->
<div id="approval-modal" class="modal-overlay">
<div class="modal-content">
<h2>อนุมัติสติ๊กเกอร์</h2>
<input type="text" id="sticker-number-input" placeholder="กรุณาระบุเลขสติ๊กเกอร์">
<div class="modal-actions">
<button id="cancel-approval" class="btn-cancel">ยกเลิก</button>
<button id="confirm-approval" class="btn-confirm">ยืนยัน</button>
</div>
</div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    const adminId = localStorage.getItem('stickerAdminId');
    if (!adminId) {
        alert('กรุณาเข้าสู่ระบบสำหรับ Admin ก่อน');
        window.location.href = 'sticker_admin_login.html';
    }
    document.getElementById('admin-id-display').textContent = adminId;
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('stickerAdminId');
        window.location.href = 'index.html';
    });
    function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
        document.getElementById(`${tabName}_content`).classList.add('active');
    }
    const firebaseConfig = { 
        apiKey: "AIzaSyBFep1y9I0OR5Hu_Gf0Mbywu-PEgFdQD2k", 
        authDomain: "smartadmin-hr-project.firebaseapp.com", 
        databaseURL: "https://smartadmin-hr-project-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "smartadmin-hr-project", 
        storageBucket: "smartadmin-hr-project.appspot.com", 
        messagingSenderId: "797763301010", 
        appId: "1:797763301010:web:2c4b5e24ac0750e67cc04b" 
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    function getFileLink(url, text) {
        if (url && url.trim() !== '' && url.trim() !== 'javascript:void(0);') {
            return `<span><a href="${url}" target="_blank" style="text-decoration:none; color:inherit;">${text} <i class="fas fa-check-circle file-indicator"></i></a></span>`;
        }
        return `<span>${text}: <i class="fas fa-times-circle file-indicator"></i></span>`;
    }
    
    function getVehicleTypeText(typeKey) {
        const types = {'moto_thai': 'จยย. (ไทย)', 'moto_foreign': 'จยย. (ต่างด้าว)', 'car_general': 'รถยนต์', 'car_mgmt': 'รถยนต์ (จัดการ)'};
        return types[typeKey] || typeKey || 'N/A';
    }

    function getStatusClass(status) {
        if (status === 'approved') return 'status-approved';
        if (status === 'rejected') return 'status-rejected';
        return 'status-pending';
    }

    const renderRow = {
        op_area: (key, req) => `
            <tr data-key="${key}" data-type="op_area">
                <td>${new Date(req.timestamp).toLocaleString('th-TH')}</td>
                <td class="details-column">
                    <span class="editable-cell" data-field="emp_name"><strong>ชื่อ:</strong> ${req.emp_name || ''}</span>
                    <span class="editable-cell" data-field="emp_code"><strong>รหัส:</strong> ${req.emp_code || ''}</span>
                    <span class="editable-cell" data-field="company"><strong>บริษัท:</strong> ${req.company || ''}</span>
                    <span class="editable-cell" data-field="department"><strong>แผนก:</strong> ${req.department || ''}</span>
                    <span class="editable-cell" data-field="position"><strong>ตำแหน่ง:</strong> ${req.position || ''}</span>
                </td>
                <td class="details-column">
                    <span class="editable-cell" data-field="vehicle_type"><strong>ประเภท:</strong> ${getVehicleTypeText(req.vehicle_type)}</span>
                    <span class="plate-number editable-cell" data-field="op_area_vehicle_reg"><strong>ทะเบียน:</strong> ${req.op_area_vehicle_reg || ''}</span>
                    <span><strong>ใบขับขี่:</strong> ${req.has_driver_license === 'yes' ? 'มี' : 'ไม่มี'}</span>
                </td>
                <td class="details-column">
                    ${getFileLink(req.vehicle_photo_url, 'รูปรถ')}
                    ${getFileLink(req.ins_photo_url, 'พรบ.')}
                    ${getFileLink(req.tax_photo_url, 'ป้ายภาษี')}
                </td>
                <td class="${getStatusClass(req.status)}">${req.status || 'pending'}</td>
                <td>
                    <div class="action-btn-group">
                        <button class="action-btn btn-edit" onclick="toggleEditMode(this)"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-approve" onclick="openApprovalModal('op_area', '${key}')"><i class="fas fa-check"></i></button>
                        <button class="action-btn btn-reject" onclick="updateStatus('op_area', '${key}', 'rejected')"><i class="fas fa-times"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteRequest('op_area', '${key}')"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`,
        checkpoint3: (key, req) => `
            <tr data-key="${key}" data-type="checkpoint3">
                <td class="details-column">${new Date(req.timestamp).toLocaleString('th-TH')}</td>
                <td class="details-column">
                    <span class="editable-cell" data-field="cp3_emp_name"><strong>ชื่อ:</strong> ${req.cp3_emp_name || ''}</span>
                    <span class="editable-cell" data-field="cp3_emp_code"><strong>รหัส:</strong> ${req.cp3_emp_code || ''}</span>
                    <span class="editable-cell" data-field="cp3_position"><strong>ตำแหน่ง:</strong> ${req.cp3_position || ''}</span>
                    <span class="editable-cell" data-field="cp3_affiliation"><strong>สังกัด:</strong> ${req.cp3_affiliation || ''}</span>
                    <span class="editable-cell" data-field="cp3_company"><strong>บริษัท:</strong> ${req.cp3_company || ''}</span>
                </td>
                <td class="details-column">
                    <span class="editable-cell" data-field="cp3_car_ownership"><strong>ประเภท:</strong> ${req.cp3_car_ownership || ''}</span>
                    <span class="plate-number editable-cell" data-field="cp3_vehicle_reg"><strong>ทะเบียน:</strong> ${req.cp3_vehicle_reg || ''}</span>
                </td>
                <td class="details-column">
                    <span class="editable-cell" data-field="cp3_contact_unit"><strong>ติดต่อ:</strong> ${req.cp3_contact_unit || ''}</span>
                    <span class="editable-cell" data-field="cp3_frequency"><strong>ความถี่:</strong> ${req.cp3_frequency || ''}</span>
                    <span class="editable-cell" data-field="cp3_purpose"><strong>วัตถุประสงค์:</strong> ${req.cp3_purpose || ''}</span>
                </td>
                <td class="${getStatusClass(req.status)}">${req.status || 'pending'}</td>
                <td>
                     <div class="action-btn-group">
                        <button class="action-btn btn-edit" onclick="toggleEditMode(this)"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-approve" onclick="openApprovalModal('checkpoint3', '${key}')"><i class="fas fa-check"></i></button>
                        <button class="action-btn btn-reject" onclick="updateStatus('checkpoint3', '${key}', 'rejected')"><i class="fas fa-times"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteRequest('checkpoint3', '${key}')"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`,
        logs: (log, allReqs) => {
            const reqData = allReqs[log.request_id];
            if (!reqData) return ''; // Skip log if original request is deleted
            const regPlate = reqData.op_area_vehicle_reg || reqData.cp3_vehicle_reg || 'N/A';
            const name = reqData.emp_name || reqData.cp3_emp_name || 'N/A';
            return `
            <tr>
                <td>${new Date(log.timestamp).toLocaleString('th-TH')}</td>
                <td>${log.admin_id}</td>
                <td>${log.request_type === 'op_area' ? 'เขตประกอบการ' : 'ป้อม 3'}</td>
                <td>${name}</td>
                <td>${regPlate}</td>
                <td>${log.sticker_number || 'N/A'}</td>
                <td class="${getStatusClass(log.action)}">${log.action}</td>
            </tr>`;
        }
    };
    
    let opAreaRequests = {};
    let checkpoint3Requests = {};
    let adminLogs = {};

    function renderTable(tbody, data, renderFunc) {
        tbody.innerHTML = '';
        const keys = Object.keys(data).reverse();
        keys.forEach(key => {
            tbody.innerHTML += renderFunc(key, data[key]);
        });
    }

    function initializeApp() {
        db.ref('sticker_requests/op_area').on('value', snapshot => {
            opAreaRequests = snapshot.val() || {};
            renderTable(document.querySelector('#op_area_table tbody'), opAreaRequests, renderRow.op_area);
            updateDashboard();
            updateLogs();
        });

        db.ref('sticker_requests/checkpoint3').on('value', snapshot => {
            checkpoint3Requests = snapshot.val() || {};
            renderTable(document.querySelector('#checkpoint3_table tbody'), checkpoint3Requests, renderRow.checkpoint3);
            updateDashboard();
            updateLogs();
        });
        
        db.ref('admin_logs').on('value', snapshot => {
            adminLogs = snapshot.val() || {};
            updateLogs();
        });
    }
    
    function updateLogs() {
        const allReqs = {...opAreaRequests, ...checkpoint3Requests};
        const logsTableBody = document.querySelector('#logs_table tbody');
        logsTableBody.innerHTML = '';
        const logsArray = Object.values(adminLogs).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        logsArray.forEach(log => {
            logsTableBody.innerHTML += renderRow.logs(log, allReqs);
        });
    }
    
    function updateDashboard() {
        const allReqs = {...opAreaRequests, ...checkpoint3Requests};
        let total = 0, approved = 0, pending = 0, rejected = 0;
        Object.values(allReqs).forEach(req => {
            total++;
            if (req.status === 'approved') approved++;
            else if (req.status === 'rejected') rejected++;
            else pending++;
        });
        document.getElementById('total-requests').textContent = total;
        document.getElementById('approved-requests').textContent = approved;
        document.getElementById('pending-requests').textContent = pending;
        document.getElementById('rejected-requests').textContent = rejected;
    }
    
    function toggleEditMode(button) {
        const row = button.closest('tr');
        const isEditing = row.classList.contains('editing');
        const type = row.dataset.type;
        const key = row.dataset.key;
        const allData = type === 'op_area' ? opAreaRequests : checkpoint3Requests;

        if (isEditing) {
            // --- Save Mode ---
            const updates = {};
            row.querySelectorAll('.editable-cell').forEach(cell => {
                const field = cell.dataset.field;
                const inputElement = cell.querySelector('input, select');
                if (inputElement && field) {
                    updates[field] = inputElement.value;
                }
            });

            db.ref(`sticker_requests/${type}/${key}`).update(updates)
                .then(() => {
                    alert('บันทึกข้อมูลเรียบร้อย');
                    row.classList.remove('editing');
                    button.innerHTML = '<i class="fas fa-edit"></i>'; // Change back to edit icon
                    button.classList.remove('btn-save');
                    button.classList.add('btn-edit');
                })
                .catch(err => alert('เกิดข้อผิดพลาด: ' + err.message));
        } else {
            // --- Edit Mode ---
            row.classList.add('editing');
            const currentData = allData[key];
            
            row.querySelectorAll('.editable-cell').forEach(cell => {
                const field = cell.dataset.field;
                const currentValue = currentData[field] || '';
                const strongText = cell.querySelector('strong').textContent;
                
                if (field === 'vehicle_type') {
                     cell.innerHTML = `<strong>${strongText}</strong> 
                        <select>
                            <option value="moto_thai" ${currentValue === 'moto_thai' ? 'selected' : ''}>จยย. (ไทย)</option>
                            <option value="moto_foreign" ${currentValue === 'moto_foreign' ? 'selected' : ''}>จยย. (ต่างด้าว)</option>
                            <option value="car_general" ${currentValue === 'car_general' ? 'selected' : ''}>รถยนต์</option>
                            <option value="car_mgmt" ${currentValue === 'car_mgmt' ? 'selected' : ''}>รถยนต์ (จัดการ)</option>
                        </select>`;
                } else {
                     cell.innerHTML = `<strong>${strongText}</strong> <input type="text" value="${currentValue}">`;
                }
            });
            
            button.innerHTML = '<i class="fas fa-save"></i>';
            button.classList.remove('btn-edit');
            button.classList.add('btn-save');
        }
    }

    function filterTable(tableId, filterText) {
        const filter = filterText.toUpperCase();
        const table = document.getElementById(tableId);
        const tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) { // Start from 1 to skip header row
            const row = tr[i];
            const textValue = row.textContent || row.innerText;
            if (textValue.toUpperCase().indexOf(filter) > -1) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        }
    }

    function updateStatus(type, key, newStatus) {
        const actionText = newStatus === 'rejected' ? 'ปฏิเสธ' : 'อนุมัติ';
        if (!confirm(`คุณต้องการ ${actionText} คำขอนี้ใช่หรือไม่?`)) return;

        const updates = { status: newStatus };
        db.ref(`sticker_requests/${type}/${key}`).update(updates)
            .then(() => {
                const logData = {
                    admin_id: adminId,
                    action: newStatus,
                    request_id: key,
                    request_type: type,
                    timestamp: new Date().toISOString()
                };
                db.ref('admin_logs').push(logData);
                alert(`คำขอถูก ${actionText} แล้ว`);
            }).catch(err => alert('เกิดข้อผิดพลาด: ' + err.message));
    }
    
    function deleteRequest(type, key) {
        if (!confirm('คุณต้องการลบข้อมูลนี้อย่างถาวรใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้')) return;
        db.ref(`sticker_requests/${type}/${key}`).remove()
            .then(() => {
                db.ref('admin_logs').push({
                    admin_id: adminId, action: 'deleted', request_id: key,
                    request_type: type, timestamp: new Date().toISOString()
                });
                alert('ลบข้อมูลสำเร็จ');
            })
            .catch(err => alert('เกิดข้อผิดพลาดในการลบ: ' + err.message));
    }

    const modal = document.getElementById('approval-modal');
    const stickerInput = document.getElementById('sticker-number-input');
    let currentApproval = {};

    function openApprovalModal(type, key) {
        currentApproval = { type, key };
        modal.style.display = 'flex';
        stickerInput.value = '';
        stickerInput.focus();
    }

    document.getElementById('cancel-approval').addEventListener('click', () => modal.style.display = 'none');
    
    document.getElementById('confirm-approval').addEventListener('click', () => {
        const stickerNumber = stickerInput.value;
        if (!stickerNumber) { alert('กรุณาใส่เลขสติ๊กเกอร์'); return; }
        
        const { type, key } = currentApproval;
        const updates = {
            status: 'approved',
            sticker_number: stickerNumber,
            approved_by: adminId,
            approved_at: new Date().toISOString()
        };
        
        db.ref(`sticker_requests/${type}/${key}`).update(updates).then(() => {
            db.ref('admin_logs').push({
                admin_id: adminId, action: 'approved', request_id: key,
                request_type: type, sticker_number: stickerNumber, timestamp: new Date().toISOString()
            });
            modal.style.display = 'none';
            alert(`อนุมัติสติ๊กเกอร์เลขที่ ${stickerNumber} สำเร็จ`);
        }).catch(err => alert('เกิดข้อผิดพลาด: ' + err.message));
    });
    
    document.getElementById('export-summary-btn').addEventListener('click', () => {
        const logsTable = document.getElementById('logs_table');
        const wb = XLSX.utils.table_to_book(logsTable, {sheet: "ประวัติการอนุมัติ"});
        XLSX.writeFile(wb, "Logs_Report.xlsx");
    });
    
    document.getElementById('export-checkpoint3-btn').addEventListener('click', () => {
        const dataToExport = [
            ["เวลาที่ขอ", "ชื่อ", "รหัส", "ตำแหน่ง", "สังกัด", "บริษัท", "ประเภทรถ", "ทะเบียน", "หน่วยงานที่ติดต่อ", "ความถี่", "วัตถุประสงค์", "สถานะ", "เลขสติ๊กเกอร์"]
        ];
        Object.values(checkpoint3Requests).forEach(req => {
            dataToExport.push([
                new Date(req.timestamp).toLocaleString('th-TH'),
                req.cp3_emp_name, req.cp3_emp_code, req.cp3_position, req.cp3_affiliation, req.cp3_company, 
                req.cp3_car_ownership, req.cp3_vehicle_reg,
                req.cp3_contact_unit, req.cp3_frequency, req.cp3_purpose, req.status, req.sticker_number || ''
            ]);
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(dataToExport);
        XLSX.utils.book_append_sheet(wb, ws, "Checkpoint3_Requests");
        XLSX.writeFile(wb, "Checkpoint3_Report.xlsx");
    });

    showTab('summary');
    initializeApp();
</script>
</body>
</html>
