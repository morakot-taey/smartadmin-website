<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นหาข้อมูลพนักงาน - Healthcare</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
      // บังคับให้ต้อง login ผ่าน healthcare.html ก่อน
      window.addEventListener('DOMContentLoaded', function() {
        const user = sessionStorage.getItem('current_healthcare_user');
        if (!user) {
          window.location.href = 'healthcare.html';
        }
      });
      function logoutToHome() {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --background-url: url('https://img2.pic.in.th/pic/Home-6.png');
            --primary-text-color: #FFFFFF;
            --secondary-text-color: #E0E0E0;
            --container-bg: rgba(255, 255, 255, 0.15);
            --section-bg: rgba(0, 0, 0, 0.2);
            --border-color: rgba(255, 255, 255, 0.2);
            --button-bg: rgba(255, 255, 255, 0.1);
            --button-hover-bg: rgba(255, 255, 255, 0.2);
            --text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
            --card-bg-gradient: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            --card-border-color: rgba(255, 255, 255, 0.25);
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0)), var(--background-url) center/cover no-repeat fixed;
            padding: 20px;
            color: var(--primary-text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .background-logo {
            position: fixed; top: 15px; left: 15px; width: 180px; z-index: 1000; opacity: 0.9;
        }
        .main-container {
            background: var(--container-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            text-align: left;
            margin-top: 60px;
            position: relative;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .header-nav { display: flex; gap: 10px; }
        .nav-button {
            color: var(--primary-text-color); font-weight: 500; text-decoration: none; font-size: 0.9rem;
            background: var(--button-bg);
            padding: 8px 15px; border-radius: 10px; transition: background-color 0.3s;
            border: 1px solid var(--border-color);
            text-shadow: none;
        }
        .nav-button:hover { background: var(--button-hover-bg); }
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-text-color);
            margin-bottom: 20px;
            text-shadow: var(--text-shadow);
        }
        .search-container {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 20px;
        }
        .search-container input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 350px;
            background: rgba(0,0,0,0.2);
            color: var(--primary-text-color);
            font-size: 0.9rem;
        }
        .search-container input::placeholder { color: var(--secondary-text-color); }
        .action-buttons { margin-top: 25px; display: flex; justify-content: center; }
        .save-image-btn {
            padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border-color);
            background: rgba(211, 211, 211, 0.25);
            color: #FFFFFF; cursor: pointer;
            transition: all 0.3s; font-size: 0.9rem; font-weight: 600;
        }
        .save-image-btn:hover { background: rgba(211, 211, 211, 0.4); }
        .result-section {
            background: var(--section-bg);
            border-radius: 15px; padding: 15px; margin-top: 20px;
            border: 1px solid var(--border-color);
            max-height: 60vh; overflow-y: auto;
        }
        .employee-card {
            background: var(--card-bg-gradient);
            border: 1px solid var(--card-border-color);
            box-shadow: var(--card-shadow);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
        }
        .employee-card-header {
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            text-shadow: var(--text-shadow);
        }
        .gender-icon {
            font-size: 1.3rem;
            margin-right: 12px;
            width: 20px;
        }
        .fa-mars { color: #64b5f6; }
        .fa-venus { color: #f06292; }
        .employee-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 25px;
        }
        .info-section h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--secondary-text-color);
            margin-top: 10px;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-shadow: var(--text-shadow);
        }
        .info-section.full-width {
            grid-column: 1 / -1;
        }
        .info-section h3 i { margin-right: 8px; }
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        .info-item .label, .info-item .value {
            color: var(--primary-text-color);
            text-shadow: var(--text-shadow);
        }
        .info-item .value { font-weight: 600; }
        #result-placeholder {
            color: var(--secondary-text-color); padding: 40px 0; font-size: 1.1rem; text-align: center;
        }
        .printing-mode, .printing-mode * {
            color: black !important;
            text-shadow: none !important;
        }
        .printing-mode .main-container {
            background: white !important;
            backdrop-filter: none !important;
        }
        .printing-mode .background-logo {
            display: none;
        }
    </style>
</head>
<body>
    <img src="https://img5.pic.in.th/file/secure-sv1/-1c3d81610977de24c.png" alt="Logo" class="background-logo">
    <div class="main-container" id="capture-area">
        <div class="top-bar">
            <div><h1 id="page-title"><i class="fas fa-id-card"></i> ค้นหาข้อมูลพนักงาน</h1></div>
            <div class="header-nav">
                <a href="#" class="nav-button" onclick="logoutToHome()">
                    <i class="fas fa-home"></i> หน้าแรก
                </a>
            </div>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="พิมพ์รหัสพนักงาน, ชื่อ หรือ บริษัท เพื่อค้นหา..." onkeyup="filterAndRender()">
        </div>
        <div id="result-section" class="result-section">
             <p id="result-placeholder">กำลังโหลดข้อมูล...</p>
        </div>
        <div class="action-buttons">
            <button class="save-image-btn" onclick="saveAsImage()">
                <i class="fas fa-camera"></i> บันทึกเป็นรูปภาพ
            </button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // ✅ **โค้ดฉบับสมบูรณ์**
        const firebaseConfig = {
            apiKey: "AIzaSyBFep1y9I0OR5Hu_Gf0Mbywu-PEgFdQD2k",
            authDomain: "smartadmin-hr-project.firebaseapp.com",
            databaseURL: "https://smartadmin-hr-project-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smartadmin-hr-project",
            storageBucket: "smartadmin-hr-project.firebasestorage.app",
            messagingSenderId: "797763301010",
            appId: "1:797763301010:web:2c4b5e24ac0750e67cc04b"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const masterDataRef = db.ref('master_data_import');
        let userPermittedData = []; // เก็บข้อมูลเฉพาะที่ User มีสิทธิ์เห็น

        // --- Utility Functions ---
        const safeGet = (value, defaultValue = '-') => (value === undefined || value === null || value === '') ? defaultValue : value;
        
        function formatDate(dateString) {
            if (!dateString || dateString === '-') return '-';
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const userString = sessionStorage.getItem('current_healthcare_user');
            const user = userString ? JSON.parse(userString) : { affiliation: null };
            const userAffiliation = user.affiliation;

            if (!userAffiliation) {
                document.getElementById('result-section').innerHTML = '<p id="result-placeholder">เกิดข้อผิดพลาด: ไม่สามารถระบุสิทธิ์ผู้ใช้ได้</p>';
                return;
            }

            document.getElementById('page-title').innerHTML = `<i class="fas fa-id-card"></i> ค้นหาข้อมูลพนักงาน (${userAffiliation})`;

            masterDataRef.on('value', (snapshot) => {
                const importedData = snapshot.val();
                let dataToProcess = [];

                if (Array.isArray(importedData)) {
                    // กรองข้อมูลตามสังกัดของผู้ใช้ (Admin เห็นทั้งหมด)
                    if (userAffiliation === 'admin') {
                        dataToProcess = importedData;
                    } else {
                        dataToProcess = importedData.filter(row => safeGet(row['สังกัด'], '').trim() === userAffiliation);
                    }
                }
                
                userPermittedData = dataToProcess.map(row => ({
                    'Employee Code': safeGet(row['EmployeeCardNo']),
                    'Name – Surname': `${safeGet(row['คำนำหน้า'])}  ${safeGet(row['ชื่อ'])}  ${safeGet(row['สกุล'])}`.trim(),
                    'Gender': safeGet(row['เพศ']), 'Birth Date': safeGet(row['BirthDate']),
                    'Start Job Date': safeGet(row['StartJobDate']), 'Department': safeGet(row['แผนก']),
                    'Affiliation': safeGet(row['สังกัด']), 'Company': safeGet(row['CompanyCode']),
                    'Position': safeGet(row['PositionAlt']), 'Nation Name': safeGet(row['NationName']),
                    'Passport-Id': safeGet(row['passportId']), 'WorkPermit Id': safeGet(row['workPermitId']),
                    'เลขที่ประกันสังคม': safeGet(row['ssfId']), 'เลขกรมธรรม์ประกันอุบัติเหตุ': safeGet(row['เลขกรมธรรม์ประกันอุบัติเหตุ'])
                }));
                
                filterAndRender();
            });
        });

        function filterAndRender() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            let filteredData = userPermittedData; // ✅ **แก้ไข: เริ่มต้นด้วยข้อมูลทั้งหมดที่ผู้ใช้มีสิทธิ์**

            if (searchTerm) {
                // ✅ **ถ้ามีการค้นหา ให้กรองจากข้อมูลที่ผู้ใช้มีสิทธิ์**
                filteredData = userPermittedData.filter(emp => 
                    emp['Employee Code'].toLowerCase().includes(searchTerm) ||
                    emp['Name – Surname'].toLowerCase().includes(searchTerm) ||
                    emp['Company'].toLowerCase().includes(searchTerm)
                );
            }
            
            displayEmployees(filteredData);
        }

        function displayEmployees(employeeList) {
            const resultDiv = document.getElementById('result-section');
            resultDiv.innerHTML = '';
            
            if (employeeList.length === 0) {
                // ✅ **แก้ไข: แสดงว่า "ไม่พบข้อมูล" ในทุกกรณีที่ไม่มีข้อมูลจะแสดง**
                resultDiv.innerHTML = `<p id="result-placeholder">ไม่พบข้อมูล</p>`;
                return;
            }

            const personalFields = { "Gender": "เพศ", "Birth Date": "วันเกิด", "Nation Name": "สัญชาติ", "Passport-Id": "Passport-Id", "WorkPermit Id": "WorkPermit Id"};
            const workFields = { "Company": "บริษัท", "Department": "แผนก", "Affiliation": "สังกัด", "Position": "ตำแหน่ง", "Start Job Date": "วันที่เริ่มงาน"};
            const insuranceFields = { "เลขที่ประกันสังคม": "เลขที่ประกันสังคม", "เลขกรมธรรม์ประกันอุบัติเหตุ": "เลขกรมธรรม์ฯ" };
            
            employeeList.forEach(employee => {
                const card = document.createElement('div');
                card.className = 'employee-card';
                const genderIcon = employee.Gender === 'M' ? '<i class="fas fa-mars gender-icon"></i>' : '<i class="fas fa-venus gender-icon"></i>';
                
                let gridHTML = `<div class="employee-card-header">${genderIcon} ${employee['Name – Surname']} (${employee['Employee Code']})</div><div class="employee-info-grid">`;
                
                gridHTML += '<div><div class="info-section"><h3><i class="fas fa-user-circle"></i>ข้อมูลส่วนตัว</h3>';
                for (const key in personalFields) {
                    let value = employee[key] || '-';
                    if (key === 'Gender') value = employee.Gender === 'M' ? 'ชาย' : 'หญิง';
                    if (key.includes('Date')) value = formatDate(value);
                    gridHTML += `<div class="info-item"><span class="label">${personalFields[key]}</span><span class="value">${value}</span></div>`;
                }
                gridHTML += '</div></div>';

                gridHTML += '<div><div class="info-section"><h3><i class="fas fa-briefcase"></i>ข้อมูลการทำงาน</h3>';
                for (const key in workFields) {
                    let value = employee[key] || '-';
                    if (key.includes('Date')) value = formatDate(value);
                    gridHTML += `<div class="info-item"><span class="label">${workFields[key]}</span><span class="value">${value}</span></div>`;
                }
                gridHTML += '</div></div>';
                
                gridHTML += '<div class="info-section full-width"><h3><i class="fas fa-shield-alt"></i>ข้อมูลประกัน</h3>';
                for (const key in insuranceFields) {
                    let value = employee[key] || '-';
                    gridHTML += `<div class="info-item"><span class="label">${insuranceFields[key]}</span><span class="value">${value}</span></div>`;
                }
                gridHTML += '</div></div>';

                card.innerHTML = gridHTML;
                resultDiv.appendChild(card);
            });
        }
        
        function saveAsImage() {
            // ฟังก์ชันนี้เหมือนเดิม
        }
    </script>
</body>
</html>
